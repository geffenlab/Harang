%%
load('F:\HarangData\K070_20170903_artificialGrammar_02.mat')
%%
stim_dur = ceil((stimInfo.t_dur+stimInfo.ISI) * exptInfo.fr);
raster = rasterize(spikes.raster, stim_dur, events.eventsOn);

%%
ssa_seq = {[1 1 1 2], [1 1 1 3], [2 2 2 1], [2 2 2 3], [3 3 3 1], ...
    [3 3 3 2]};
seq_ind = {...
    strfind(stimInfo.order,ssa_seq{1}),...
    strfind(stimInfo.order,ssa_seq{2}),...
    strfind(stimInfo.order,ssa_seq{3}),...
    strfind(stimInfo.order,ssa_seq{4}),...
    strfind(stimInfo.order,ssa_seq{5}),...
    strfind(stimInfo.order,ssa_seq{6})};
ssa_n = {...
    [],...
    [22,26,28,30,45,49,50,52,58,63,65,91,92,96,100,117,125,132,133,134,...
        136,169,170,185,200,206,222,227,228,235,304,307],...
    [2,14,21,23,25,26,30,43,46,48,49,56,58,60,61,66,70,90,92,99,97,100,...
        102,122,129,132,133,134,146,147,149,150,155,156,169,175,179,184,...
        186,190,195,206,222,227,252,257,262,270,275,281,287,290,304,305,...
        314],...
    [25,30,40,53,55,58,61,63,97,102,109,117,134,139,149,184,186,190,206,...
        228,231,251,296,299],...
    [21,22,23,26,30,42,49,50,58,59,60,84,87,92,100,108,133,147,155,156,...
        184,193,206,229,262,272],...
    [14,21,25,26,42,45,48,55,57,58,60,70,99,108,112,133,143,184,196,200,...
        228,251,304],...
    };
ssa_anti_n = 0;
ssa_count = cellfun(@length,ssa_n);
%% show individual trials
for s = 4 : length(ssa_seq)
    neurons = ssa_n{s};
    indices = seq_ind{s};
    for n = 1 : length(neurons)
        neuron = neurons(n);
        for i = 1 : length(indices)
            index = indices(i);
            dat = [raster(neuron,:,index) raster(neuron,:,index+1)...
                raster(neuron,:,index+2) raster(neuron,:,index+3)];
            plot(dat,'k','LineWidth',2); hold on;
            title(['Seq [' num2str(ssa_seq{s}) ...
                ']    Neuron ' num2str(neuron)...
                '    Trial ' num2str(index)])
            m = ceil(max(dat));
            plot([12-.0001 12+.0001],[0 m],'b--','LineWidth',2)
            plot([23-.0001 23+.0001],[0 m],'b--','LineWidth',2)
            plot([34-.0001 34+.0001],[0 m],'b--','LineWidth',2)
            hold off;
            plotprefs
            pause
        end
    end
end
%% show averages
for s = 4 : length(ssa_seq)
    neurons = ssa_n{s};
    indices = seq_ind{s};
    for n = 1 : length(neurons)
        neuron = neurons(n);
        dat = mean([mean(raster(neuron,:,indices),3)'...
            mean(raster(neuron,:,indices+1),3)'...
            mean(raster(neuron,:,indices+2),3)'...
            mean(raster(neuron,:,indices+3),3)']);
        plot(dat,'k','LineWidth',2);
        title(['Seq [' num2str(ssa_seq{s}) ...
            ']    Neuron ' num2str(neuron)])
        axis([0 5 0 inf])
        plotprefs; pause
    end
end
